**MQTT**
========

.. note::
   На устройстве дополнительно реализована возможность блокирования работы через облако Welrok. Данная блокировка регулируется `параметром <parameters_ru.html>`_ ``cloudBlock`` 115 = **1** или со страницы http://``dev_ip``, где ``dev_ip`` - ip адрес устройства в локальной сети.
   Если включены блокировки сразу  по `параметрам <parameters_ru.html>`_ ``lanBlock`` 114 = **1** и ``cloudBlock`` 115 = **1**; пункт меню самого устройства ``bLc`` = **on**, то устройство заблокировано полностью для удаленного управления. Управление возможно только с кнопок.

Доступна возможность сбора телеметрии и управление ключевыми параметрами по протоколу MQTT.
Настройки подключения к MQTT серверу доступны только через веб-интерфейс устройства, который доступен по его локальному IP адресу:

``Host``/``Port`` - IP адрес и порт MQTT сервера

``User``/``Password`` - имя пользователя и пароль для подключения к MQTT серверу

``Keep alive`` - максимально допустимый промежуток времени без обмена данными

``QoS`` - уровень качества обслуживания

``Publish prefix`` - префикс публикации для отправки телеметрии

``Subscribe path`` - название пути для подписки на комманды

``Client ID`` - имя устройства

.. note::
   Если на сервере MQTT не настроена авторизация, то поля ``User``/ ``Password`` игнорируются.

.. important::
   Максимальная длина имени ``User`` и ``Password`` составляет 30 символов.

.. rubric:: **ПУБЛИКУЮТСЯ ТОПИКИ** 

Раз в минуту, с интервалом +/- 5 секунд, публикуются данные в следующие топики:

``Publish prefix``/``Client ID``/``get``/``floorTemp`` - показания датчика температуры пола, возвращается значение аналогичное `телеметрии <telemetry_ru.html>`_, запрошенной по API по параметру **«t.1»** в °C строкой «xx.x»

``Publish prefix``/``Client ID``/``get``/``airTemp`` - показания датчика температуры воздуха,, возвращается значение аналогичное `телеметрии <telemetry_ru.html>`_, запрошенной по API по параметру **«t.2»** в °C строкой «xx.x» 

``Publish prefix``/``Client ID``/``get``/``protTemp`` - показания внутреннего датчика перегрева, возвращается значение аналогичное `телеметрии <telemetry_ru.html>`_, запрошенной по API по параметру **«t.0»**. Возвращается в °C строкой «xx.x»

``Publish prefix``/``Client ID``/``get``/``setTemp`` - температура уставки, возвращается значение аналогичное `телеметрии <telemetry_ru.html>`_, запрошенной по API по параметру **«t.5»**. Возвращается в °C строкой «xx.x»

``Publish prefix``/``Client ID``/``get``/``powerOff`` - устройство выключено, возвращается значение аналогичное `телеметрии <telemetry_ru.html>`_, запрошенной по API по параметру **«f.16»**. Возвращается строкой, где «0» - включено, «1» - выключено

``Publish prefix``/``Client ID``/``get``/``load`` - состояние нагрузки, возвращается значение аналогичное `телеметрии <telemetry_ru.html>`_, запрошенной по API по параметру **«f.0»**. Возвращается строкой, где «0» - выключена, «1» - включена

``Publish prefix``/``Client ID``/``get``/``typeCtrl`` – тип контроля, возвращается значение аналогичное `телеметрии <telemetry_ru.html>`_, запрошенной по API по параметру **«m.0»**. Возвращается строкой, где 0-по полу, 1- по воздуху, 2- по воздуху с ограничением по полу

``Publish prefix``/``Client ID``/``get``/``maxFlrTmp`` – максимально допустимая температура пола для режима контроля «по воздуху, с ограничением по полу», выполняется аналогично команде API в `параметрах <parameters_ru.html>`_.  ``{"cmd":1}``

``Publish prefix``/``Client ID``/``get``/``minFlrTmp`` – минимально допустимая температура пола для режима контроля «по воздуху, с ограничением по полу», выполняется аналогично команде API в `параметрах <parameters_ru.html>`_.  ``{"cmd":1}``

``Publish prefix``/``Client ID``/``get``/``bright`` – текущая яркость экрана терморегулятора, читается аналогично `параметрам <parameters_ru.html>`_, запрошенным по API командой ``{"cmd":1}``.Возвращается строкой, со значениями от 0 до 10.

``Publish prefix``/``Client ID``/``get``/``parameters`` – запрос параметров, выполняется аналогично команде API в `параметрах <parameters_ru.html>`_. ``{"cmd":1}``

``Publish prefix``/``Client ID``/``get``/``schedule`` - запрос расписания, выполняется аналогично команде API в `параметрах <parameters_ru.html>`_.  ``{"cmd":2}``

``Publish prefix``/``Client ID``/``get``/``api`` – ответ на отправку команды set/api

.. rubric:: **ТОПИКИ ДЛЯ УПРАВЛЕНИЯ** 

Доступны следующие топики для управления:

.. note:: 
   После отправки команды управления, через 3-5 секунд происходит внеочередная публикация данных.

``Subscribe path``/``Client ID``/``set``/``setTemp`` - установка температуры уставки. Передается строкой в формате «xx.x»

``Subscribe path``/``Client ID``/``set``/``bright`` - яркость дисплея. Передается строкой в формате «x». Значения от 0 до 10.

``Subscribe path``/``Client ID``/``set``/``powerOff`` - выключение устройства. Передается строкой в формате «x». Значения 0 или 1, где 0 - включено 1 - выключено

``Subscribe path``/``Client ID``/``set``/``mode`` - выбор режима работы. Передается строкой в формате «x». Значения от 0 или 1, где 0 - расписание, 3 - ручной.

``Subscribe path``/``Client ID``/``set``/``typeCtrl`` – тип контроля: 0-по полу, 1- по воздуху, 2- по воздуху с ограничением по полу, аналогично `параметру <parameters_ru.html>`_ ``controlType``

``Publish prefix``/``Client ID``/``set``/``maxFlrTmp`` – максимально допустимая температура пола для режима контроля «по воздуху, с ограничением по полу».  Передается строкой в формате «xx.x»

``Publish prefix``/``Client ID``/``set``/``minFlrTmp`` – минимально допустимая температура пола для режима контроля «по воздуху, с ограничением по полу». Передается строкой в формате «xx.x»

``Subscribe path``/``Client ID``/``set``/``schedule`` – установка расписания (устанавливается на 1 день). Передача команды выполняется аналогично команде API в `расписании <schedule_ru.html>`_ отправкой JSON содержащим sn устройства, номер недели и двумерный массив с периодами и температурой.

``Subscribe path``/``Client ID``/``set``/``parameters`` – установка параметров. Передача команды выполняется аналогично команде API в `параметрах <parameters_ru.html>`_ отправкой JSON содержащим sn устройства и двумерный массив с нужными параметрами, его типом и значением.

``Subscribe path``/``Client ID``/``set``/``api`` – дублирует функционал webApi, позволяя передавать команды в формате API. 

.. Important::
   ``setTemp`` задается на основании выбранного типа контроля. Если выбран "по полу", то будет установлен для пола. Если выбран "по воздуху" или "по воздуху с ограничением по полу", то будет установлен для воздуха.

.. note::
   Температура датчика пола в пользовательском меню устройства и через MQTT изменяется с шагом в 1 °C во всем рабочем диапазоне. Температура датчика воздуха в пользовательском меню устройства изменяется с шагом 1 °C в диапазоне от -15 °C до -10 °C, с шагом 0.5 °C в диапазоне от -10 °C до 75 °C. Температура датчика воздуха при управлении через API изменяется с шагом 0.1 °C во всем рабочем диапазоне.

.. note::
   Параметры 29 и 31, в режиме работы по расписанию и временном режиме, могут принимать значения 127 и -127, что соответствует значениям уставки **on** (нагрузка всегда включена) и **off** (нагрузка всегда отключена) в графическом интерфейсе и на дисплее устройства.